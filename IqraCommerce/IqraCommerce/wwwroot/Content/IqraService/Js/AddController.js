var Controller=new function(n){function t(){function w(){var n=Global.Copy({},i,!0),r;for(r in u)u[r].dataset.dateformat&&u[r].value&&(n[r]=Global.DateTime.GetObject(u[r].value,u[r].dataset.dateformat||Global.DatePicker.ClientFormat).format(Global.DatePicker.ServerFormat));return t.model&&t.fields&&t.fields.each(function(){var i=this+"";n[i]=t.model[i]}),t.postdata&&Global.Copy(n,t.postdata,!0),n.IsValid=t.onsubmit?t.onsubmit(n,t.model,i)!=!1:!0,n}function b(){var n,f;return i.IsValid&&(r.Wait(),n=t.save||"/"+t.name+"s/Create",e||(n=t.savechange||"/"+t.name+"s/SaveChange"),f=w(),f.IsValid?Global.Uploader.upload({url:n,data:f,onComplete:function(f){if(f.IsError)o.Save(f,n);else{if(r.Free(),t.model)for(var e in t.model)typeof i[e]!="undefined"&&(t.model[e]=i[e]);t.onsavesuccess&&t.onsavesuccess(f,i,u);h()}},onError:function(t){t.Id=-8;o.Save(t,n)}}):(alert("Validation Errors."),r.Free())),!1}function h(){activeSave=!1;r.Hide(function(){});document.title=a}function v(n){var i=t.name+(t.name[t.name.length-1]=="s"||n?"":"s");return i.replace(/[A-Z]/g,function(n){return" "+n})}function c(r){var o,e;r=r||{};o={};Global.Copy(o,r,!0);f.Model=r;for(e in u)u[e].dataset.dateformat&&/^\/Date\(\d+\)\/$/.test(r[e])&&(r[e]=r[e].getDate().format(Global.DatePicker.ClientFormat));for(e in i)i[e]=r[e]||"";i.Id=r.Id?r.Id:n;f.Options.each(function(){this.data&&this.val?(this.selectedValue=r[this.Id],this.val(r[this.Id])):this.selectedValue=r[this.Id]});f.BaseChanged[t.name]&&f.BaseChanged[t.name].each(function(){$(u[this]).change()})}function k(n){c(n);t.details&&(r.Wait("Please wait while loading Doctor details......."),Global.CallServer(t.details(n),function(i){if(i.IsError)o.Load(i,t.details(n));else{if(!i.Data){i.Id=-1;o.Load(i);return}r.Free();for(var u in i.Data)n[u]=i.Data[u]||"";c(n)}},function(i){i.Id=-8;o.Load(i,t.details(n))},{},"POST"))}function y(n){if(r.Show(),a=document.title,n)e=!1,k(n),document.title=i.Title=t.edittitle||t.title||"Edit "+v(!0);else{e=!0;n={};for(var o in i)n[o]="";c(n);document.title=i.Title=t.addtitle||t.title||"Add New "+v(!0)}t.onshow&&t.onshow(n,u,f,e,r,i)}function p(n){Global.Free();r=Global.Window.Bind(n,t.width);s=r.View.find(".form");l.Events.Bind(t.model);t.dropdownList&&t.dropdownList.each&&f.Bind(t.dropdownList);t.onviewcreated&&t.onviewcreated(r,u,f,e,i);y(t.model)}var l=this,s,t,i={},a=document.title,e=!0,r,u,o=new function(){this.Save=function(n,i){if(r.Free(),t.onerror)t.onerror(n);else Global.Error.Show(n,{path:i,section:"AddController.Add",user:t.name})};this.Load=function(n,i){r.Free();Global.Error.Show(n,{path:i,section:"AddController load]",user:t.name});h()}},f;(function(n){n.SetAddNew=function(n){for(var t in n.add)n[t.toLowerCase()]=n[t];n.add.name=n.add.name||n.title||n.Id.replace(/id\s*$/i,"");r.View.find("#btn_add_new_"+n.title.toLowerCase()).click(function(){setTimeout(function(){n.add.onSaveSuccess=n.add.onsavesuccess||function(t,i){$(u[n.field]).prepend('<option value="'+t.Data+'">'+i.Name+"<\/option>").val(t.Data).change()};Global.Add(n.add)},0)})}})(this);f=new function(){function f(n){return n.elm=$(u[n.Id]).empty(),n.type=="AutoComplete"?Global.AutoComplete.Bind(n):Global.DropDown.Bind(n),n.elm}function e(t,i){var u=i.url;i.url="";i.datasource=i.datasource||[];t.change=function(r){i.datasource=i.datasource&&i.datasource.length?i.datasource:n;t.onchange&&t.onchange(r);i.url=typeof u=="function"?u(r,t):u;i.Reload()};r.call(this,i)}function r(n){var u=typeof n.url=="function"?n.url.call(this):n.url,i=Global.Copy(n,{Id:n.Id,datasource:n.datasource,valuefield:n.valuefield,textfield:n.textfield,ondatabinding:n.ondatabinding},!0),r;n.change&&e(i,n.change);i.change=n.change||n.onchange;for(r in i)t[r]=t[r.toLowerCase()]||t[r];f(i);n.add&&l.SetAddNew(n)}var i=this;this.BaseChanged={};this.Model={};this.Options=[];this.Bind=function(n){i.BaseChanged[t.name]=[];n.each(function(){r(this)});i.Options=n}};this.Show=function(n){if(t=n,r)i={},u=Global.Form.Bind(i,s),y(t.model);else if(t.template||!t.columns){var f=t.template||"/Areas/"+t.name+"/Templates/Add.html";Global.LoadTemplate(f,function(n){p(n)},function(){})}else Global.Add({model:t,url:IqraConfig.Url.Js.AddFormController,onSuccess:function(n){p(n)}})};this.Events=new function(){var t=this,n=!1;this.Bind=function(t){n||(t=t||{},n=!0,u=Global.Form.Bind(i,s),s.find(".btn_cancel").click(h),Global.Click(r.View.find(".btn_save"),b))}}}this.Wait=!0;models={};this.Show=function(n){for(var i in n)n[i.toLowerCase()]=n[i];n.dropdownlist&&n.dropdownlist.each(function(){for(var n in this)this[n.toLowerCase()]=this[n]});n.name=n.name||Global.Guid();models[n.name]||(models[n.name]=new t);models[n.name].Show(n)}}